#!/usr/bin/env python3
"""Convert VCF to 23andMe format for testing microarray adapter.

Generates synthetic 23andMe-format files from mtDNA VCF data using the
RSID lookup table generated from dbSNP.

Usage:
    python generate_23andme_from_vcf.py --vcf input.vcf.gz --sample HG00096 --output sample.txt

Or generate all samples:
    python generate_23andme_from_vcf.py --vcf input.vcf.gz --all --outdir samples/
"""

import argparse
import gzip
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional, Tuple

import pysam


def load_rsid_lookup(lookup_path: str) -> Dict[Tuple[int, str, str], str]:
    """Load position/ref/alt to RSID lookup table.

    Returns dict mapping (position, ref, alt) -> rsid
    """
    lookup = {}

    with open(lookup_path) as f:
        header = f.readline()  # Skip header
        for line in f:
            parts = line.strip().split('\t')
            if len(parts) >= 4:
                pos = int(parts[0])
                ref = parts[1]
                alt = parts[2]
                rsid = parts[3]
                lookup[(pos, ref, alt)] = rsid

    return lookup


def generate_internal_rsid(pos: int, ref: str, alt: str) -> str:
    """Generate internal RSID for variants not in dbSNP.

    Format: i{position}_{ref}_{alt}
    """
    return f"i{pos}_{ref}_{alt}"


def vcf_to_23andme(
    vcf_path: str,
    sample_id: str,
    rsid_lookup: Dict[Tuple[int, str, str], str],
    reference_path: Optional[str] = None,
) -> List[str]:
    """Convert VCF sample to 23andMe format lines.

    Args:
        vcf_path: Path to VCF file
        sample_id: Sample ID to extract
        rsid_lookup: Position/ref/alt to RSID mapping
        reference_path: Optional path to reference FASTA

    Returns:
        List of 23andMe format lines
    """
    lines = []

    # Add 23andMe header
    lines.append(f"# This data file generated by evehap vcf-to-23andme converter")
    lines.append(f"# {datetime.now().isoformat()}")
    lines.append("#")
    lines.append("# rsid\tchromosome\tposition\tgenotype")

    # Open VCF
    vcf = pysam.VariantFile(vcf_path)

    # Find sample index
    if sample_id not in vcf.header.samples:
        raise ValueError(f"Sample {sample_id} not found in VCF")

    sample_idx = list(vcf.header.samples).index(sample_id)

    # Process variants
    for record in vcf.fetch():
        chrom = record.chrom
        if chrom not in ["MT", "chrM", "chrMT"]:
            continue

        pos = record.pos
        ref = record.ref

        # Get genotype for this sample
        gt = record.samples[sample_id].get("GT", (None,))

        if gt is None or gt[0] is None:
            continue

        allele_idx = gt[0]

        # Skip reference genotypes (allele_idx == 0)
        # 23andMe files only include variant positions
        if allele_idx == 0:
            continue

        # Get allele (1+ = alt)
        alts = list(record.alts) if record.alts else []
        if allele_idx - 1 < len(alts):
            allele = alts[allele_idx - 1]
        else:
            continue

        # For multi-base alleles, handle each position
        if len(ref) == 1 and len(allele) == 1:
            # Simple SNP
            lookup_key = (pos, ref, allele)
            rsid = rsid_lookup.get(lookup_key) or generate_internal_rsid(pos, ref, allele)
            lines.append(f"{rsid}\tMT\t{pos}\t{allele}")
        else:
            # Complex allele - emit the first base
            lookup_key = (pos, ref[0], allele[0] if allele else ref[0])
            rsid = rsid_lookup.get(lookup_key) or generate_internal_rsid(pos, ref[0], allele[0] if allele else ref[0])
            lines.append(f"{rsid}\tMT\t{pos}\t{allele[0] if allele else ref[0]}")

    vcf.close()

    return lines


def write_23andme_file(lines: List[str], output_path: str) -> None:
    """Write 23andMe format file."""
    with open(output_path, 'w') as f:
        f.write('\n'.join(lines) + '\n')


def get_vcf_samples(vcf_path: str) -> List[str]:
    """Get list of sample IDs from VCF."""
    vcf = pysam.VariantFile(vcf_path)
    samples = list(vcf.header.samples)
    vcf.close()
    return samples


def main():
    parser = argparse.ArgumentParser(description="Convert VCF to 23andMe format")
    parser.add_argument("--vcf", "-v", required=True, help="Input VCF file")
    parser.add_argument("--sample", "-s", help="Sample ID to convert")
    parser.add_argument("--output", "-o", help="Output file path")
    parser.add_argument("--all", action="store_true", help="Convert all samples")
    parser.add_argument("--outdir", "-d", help="Output directory (with --all)")
    parser.add_argument("--rsid-lookup", default="data/dbsnp/mtdna_rsids.tsv",
                        help="Path to RSID lookup table")
    parser.add_argument("--list-samples", action="store_true",
                        help="List samples in VCF and exit")

    args = parser.parse_args()

    # List samples mode
    if args.list_samples:
        samples = get_vcf_samples(args.vcf)
        print(f"Found {len(samples)} samples in {args.vcf}:")
        for s in samples[:20]:
            print(f"  {s}")
        if len(samples) > 20:
            print(f"  ... and {len(samples) - 20} more")
        return

    # Load RSID lookup
    lookup_path = Path(args.rsid_lookup)
    if not lookup_path.exists():
        # Try relative to script location
        script_dir = Path(__file__).parent.parent
        lookup_path = script_dir / args.rsid_lookup

    if lookup_path.exists():
        print(f"Loading RSID lookup from {lookup_path}")
        rsid_lookup = load_rsid_lookup(str(lookup_path))
        print(f"Loaded {len(rsid_lookup)} RSIDs")
    else:
        print(f"Warning: RSID lookup not found at {lookup_path}, using generated RSIDs")
        rsid_lookup = {}

    # Convert samples
    if args.all:
        if not args.outdir:
            print("Error: --outdir required with --all", file=__import__('sys').stderr)
            return

        outdir = Path(args.outdir)
        outdir.mkdir(parents=True, exist_ok=True)

        samples = get_vcf_samples(args.vcf)
        print(f"Converting {len(samples)} samples to {outdir}")

        for sample_id in samples:
            try:
                lines = vcf_to_23andme(args.vcf, sample_id, rsid_lookup)
                output_path = outdir / f"{sample_id}.txt"
                write_23andme_file(lines, str(output_path))
                print(f"  ✓ {sample_id} ({len(lines) - 4} variants)")
            except Exception as e:
                print(f"  ✗ {sample_id}: {e}")

        print(f"\nDone! Files written to {outdir}")

    else:
        if not args.sample:
            print("Error: --sample required (or use --all)", file=__import__('sys').stderr)
            return

        output_path = args.output or f"{args.sample}.txt"

        print(f"Converting {args.sample} from {args.vcf}")
        lines = vcf_to_23andme(args.vcf, args.sample, rsid_lookup)
        write_23andme_file(lines, output_path)
        print(f"Written {len(lines) - 4} variants to {output_path}")


if __name__ == "__main__":
    main()

