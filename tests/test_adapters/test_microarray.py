"""Tests for evehap.adapters.microarray module."""

from pathlib import Path

import pytest

from evehap.adapters.microarray import MicroarrayAdapter
from evehap.core.profile import AlleleProfile


class TestMicroarrayAdapter:
    """Tests for MicroarrayAdapter class."""

    def test_format_name(self) -> None:
        """Test format_name returns 'Microarray'."""
        adapter = MicroarrayAdapter()
        assert adapter.format_name == "Microarray"

    def test_init_defaults(self) -> None:
        """Test default initialization."""
        adapter = MicroarrayAdapter()
        assert adapter.format_type == "auto"

    def test_init_custom(self) -> None:
        """Test custom initialization."""
        adapter = MicroarrayAdapter(format_type="23andme")
        assert adapter.format_type == "23andme"


class TestMicroarrayAdapterDetection:
    """Tests for format detection."""

    def test_detect_23andme_format(self, tmp_path: Path) -> None:
        """Test detection of 23andMe format."""
        # Create 23andMe-style file
        test_file = tmp_path / "genome.txt"
        with open(test_file, "w") as f:
            f.write("# This data file generated by 23andMe at\n")
            f.write("#\n")
            f.write("# rsid\tchromosome\tposition\tgenotype\n")
            f.write("rs123456\t1\t12345\tAA\n")
            f.write("i123456\tMT\t73\tG\n")

        adapter = MicroarrayAdapter()
        format_type = adapter._detect_format(str(test_file))
        assert format_type == "23andme"

    def test_detect_ancestry_format(self, tmp_path: Path) -> None:
        """Test detection of AncestryDNA format."""
        # Create AncestryDNA-style file
        test_file = tmp_path / "genome.txt"
        with open(test_file, "w") as f:
            f.write("#AncestryDNA raw data download\n")
            f.write("rsid\tchromosome\tposition\tallele1\tallele2\n")
            f.write("rs123456\t1\t12345\tA\tA\n")
            f.write("rs789012\t26\t73\tG\tG\n")  # MT is chromosome 26 in Ancestry

        adapter = MicroarrayAdapter()
        format_type = adapter._detect_format(str(test_file))
        assert format_type == "ancestry"

    def test_detect_unknown_format(self, tmp_path: Path) -> None:
        """Test that unknown formats return None."""
        test_file = tmp_path / "unknown.txt"
        with open(test_file, "w") as f:
            f.write("random data\n")
            f.write("not a genotype file\n")

        adapter = MicroarrayAdapter()
        format_type = adapter._detect_format(str(test_file))
        assert format_type is None


class TestMicroarrayAdapterExtractProfile:
    """Tests for MicroarrayAdapter.extract_profile()."""

    @pytest.fixture
    def sample_23andme(self, tmp_path: Path) -> Path:
        """Create a sample 23andMe file with mtDNA data."""
        test_file = tmp_path / "genome_23andme.txt"
        with open(test_file, "w") as f:
            f.write("# This data file generated by 23andMe\n")
            f.write("#\n")
            f.write("# rsid\tchromosome\tposition\tgenotype\n")
            # Some autosomal SNPs (should be ignored)
            f.write("rs123456\t1\t12345\tAA\n")
            f.write("rs789012\t2\t67890\tGC\n")
            # mtDNA SNPs
            f.write("i3001997\tMT\t73\tG\n")      # A73G
            f.write("i3001998\tMT\t263\tG\n")    # A263G
            f.write("i3001999\tMT\t750\tG\n")    # A750G
            f.write("i3002000\tMT\t16519\tC\n")  # T16519C
        return test_file

    @pytest.fixture
    def sample_ancestry(self, tmp_path: Path) -> Path:
        """Create a sample AncestryDNA file with mtDNA data."""
        test_file = tmp_path / "genome_ancestry.txt"
        with open(test_file, "w") as f:
            f.write("#AncestryDNA raw data download\n")
            f.write("rsid\tchromosome\tposition\tallele1\tallele2\n")
            # Autosomal SNPs (should be ignored)
            f.write("rs123456\t1\t12345\tA\tA\n")
            # mtDNA SNPs (chromosome 26 in Ancestry format)
            f.write("rs123\t26\t73\tG\tG\n")
            f.write("rs456\t26\t263\tG\tG\n")
        return test_file

    def test_extract_profile_23andme(self, sample_23andme: Path) -> None:
        """Test extracting profile from 23andMe format."""
        adapter = MicroarrayAdapter(format_type="23andme")

        profile = adapter.extract_profile(str(sample_23andme))

        assert isinstance(profile, AlleleProfile)
        assert profile.source_format == "Microarray"
        # Should have 4 mtDNA positions
        assert len(profile.covered_positions) == 4

        # Check specific positions
        assert 73 in profile.covered_positions
        assert 263 in profile.covered_positions

    def test_extract_profile_ancestry(self, sample_ancestry: Path) -> None:
        """Test extracting profile from AncestryDNA format."""
        adapter = MicroarrayAdapter(format_type="ancestry")

        profile = adapter.extract_profile(str(sample_ancestry))

        assert isinstance(profile, AlleleProfile)
        assert len(profile.covered_positions) == 2
        assert 73 in profile.covered_positions

    def test_extract_profile_auto_detect(self, sample_23andme: Path) -> None:
        """Test auto-detection of format."""
        adapter = MicroarrayAdapter(format_type="auto")

        profile = adapter.extract_profile(str(sample_23andme))

        assert isinstance(profile, AlleleProfile)
        assert len(profile.covered_positions) > 0

    def test_extract_profile_file_not_found(self) -> None:
        """Test FileNotFoundError for missing file."""
        adapter = MicroarrayAdapter()

        with pytest.raises(FileNotFoundError):
            adapter.extract_profile("/nonexistent/file.txt")

    def test_extract_profile_variants(self, sample_23andme: Path) -> None:
        """Test that variants are correctly extracted."""
        adapter = MicroarrayAdapter(format_type="23andme")

        profile = adapter.extract_profile(str(sample_23andme))

        # Position 73 should have G
        obs = profile.observations.get(73)
        assert obs is not None
        assert "G" in obs.alleles


